<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solver Sync Test</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            background: #1e293b; 
            padding: 20px; 
            border-radius: 12px;
        }

        .video-box { background: #000; border-radius: 8px; overflow: hidden; position: relative; }
        .label { position: absolute; top: 10px; left: 10px; font-size: 12px; color: #38bdf8; z-index: 10; }
        
        video { width: 100%; display: block; }

        .controls { 
            margin-top: 20px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            background: #334155; 
            padding: 15px; 
            border-radius: 8px; 
        }
        
        input[type=range] { flex-grow: 1; }
        button { background: #38bdf8; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>Solver Capability Test</h2>
    
    <div class="grid">
        <div id="plot"></div>

        <div class="video-box">
            <span class="label">PRESSURE CONTOUR</span>
            <video id="simVideo" src="images/Video.mp4" muted preload="auto"></video>
        </div>
    </div>

    <div class="controls">
        <button id="playBtn">PLAY</button>
        <input type="range" id="slider" min="0" max="100" step="0.1" value="0">
        <span id="timer">0.000s</span>
    </div>
</div>

<script>
    const video = document.getElementById('simVideo');
    const slider = document.getElementById('slider');
    const playBtn = document.getElementById('playBtn');
    const timer = document.getElementById('timer');

    // 1. Load CSV Data
    let dataMin = 0, dataMax = 1; // will be replaced after parsing
    let csvTimes = [];
    Papa.parse("data/data.csv", {
        download: true,
        header: true,
        dynamicTyping: false,
        complete: function(results) {
            // Filter out empty rows and map to numeric arrays.
            const rows = results.data.filter(r => r && (r["Time (s)"] !== undefined && r["Time (s)"] !== ""));
            csvTimes = rows.map(d => parseFloat(d["Time (s)"]));
            const pressure = rows.map(d => parseFloat(d["Pressure (MPa)"]));
            // remove NaNs if any
            const valid = csvTimes.map((t, i) => ({t, p: pressure[i]})).filter(tp => !isNaN(tp.t) && !isNaN(tp.p));
            const time = valid.map(v => v.t);
            const pres = valid.map(v => v.p);
            if (time.length === 0) {
                console.error('No valid CSV data found.');
                return;
            }
            dataMin = Math.min.apply(null, time);
            dataMax = Math.max.apply(null, time);
            initPlot(time, pres);
        },
        error: function(err) { console.error('PapaParse error', err); }
    });

    function initPlot(x, y) {
        const trace = {
            x: x, y: y,
            type: 'scatter',
            mode: 'lines',
            line: { color: '#38bdf8' }
        };

        const layout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#ccc' },
            margin: { t: 40, r: 20, b: 40, l: 40 },
            xaxis: { gridcolor: '#444', title: 'Time (s)' },
            yaxis: { gridcolor: '#444', title: 'Pressure (MPa)' },
            shapes: [{
                type: 'line', x0: x.length ? x[0] : 0, x1: x.length ? x[0] : 0, y0: 0, y1: 1, yref: 'paper',
                line: { color: '#fbbf24', width: 2 } // Gold seek line
            }]
        };

        Plotly.newPlot('plot', [trace], layout);
        setupEvents(x[0], x[x.length-1]);
    }

    function setupEvents(csvMin = 0, csvMax = 1) {
        // csvMin and csvMax are used to map video time -> CSV time for the seek line
        // Play/Pause logic
        playBtn.addEventListener('click', () => {
            if (video.paused) {
                video.play();
                playBtn.innerText = "PAUSE";
                updateLoop();
            } else {
                video.pause();
                playBtn.innerText = "PLAY";
            }
        });

        // Slider scrubbing logic
        slider.addEventListener('input', () => {
            const percent = parseFloat(slider.value) / 100;
            const timeForVideo = (video.duration && !isNaN(video.duration)) ? percent * video.duration : 0;
            const timeForData = csvMin + percent * (csvMax - csvMin);
            if (!isNaN(timeForVideo)) video.currentTime = timeForVideo;
            syncUI(timeForVideo, timeForData);
        });

        function updateLoop() {
            if (!video.paused) {
                // compute corresponding CSV time from video currentTime
                const percent = (video.duration && !isNaN(video.duration) && video.duration > 0) ? (video.currentTime / video.duration) : 0;
                const dataTime = csvMin + percent * (csvMax - csvMin);
                syncUI(video.currentTime, dataTime);
                requestAnimationFrame(updateLoop);
            }
        }

        function syncUI(currTime, csvTime) {
            // Move slider (as percent)
            if (video.duration && !isNaN(video.duration) && video.duration > 0) {
                slider.value = (currTime / video.duration) * 100;
            }
            // Update text timer
            timer.innerText = (isFinite(currTime) ? currTime.toFixed(3) : '0.000') + "s";
            // Move plot seek line (use csvTime if provided, otherwise try currTime)
            const seekTime = (typeof csvTime === 'number' && !isNaN(csvTime)) ? csvTime : currTime;
            Plotly.relayout('plot', {
                'shapes[0].x0': seekTime,
                'shapes[0].x1': seekTime
            });
        }

        // Ensure slider range and initial UI once video metadata is loaded
        video.addEventListener('loadedmetadata', () => {
            if (video.duration && !isNaN(video.duration)) {
                // slider represents percent 0..100
                slider.value = 0;
            }
        });

        // If video errors, log to console for easier debugging
        video.addEventListener('error', (e) => console.error('Video error', e));
    }
</script>

</body>
</html>